# 배포 이미지 최적화 작업 기록

## 📋 문제 발생 배경

### 초기 문제: Vercel 배포 실패
- **에러**: Function exceeded maximum size (300MB limit)
- **실제 크기**: 1.64GB
- **원인**: 크롤링한 모든 이미지(수천 개)가 배포에 포함됨

## 🔍 문제 분석

### 1. 이미지 관리 구조의 문제
```
현재 구조:
- 크롤링: 청약 단지당 100~200개 이미지 수집
- DB 저장: 필요한 이미지만 선별해서 저장 (청약당 3~10개)
- 배포: 모든 크롤링 이미지가 포함됨 ❌
```

**필요한 구조**:
```
- 크롤링: public/uploads/subscriptions/ (로컬 전용)
- 배포용: public/images/subscriptions/ (DB 선별 이미지만)
- 배포: DB에 저장된 이미지만 포함 ✅
```

### 2. 이미지 경로 구조

**원본 크롤링 경로**:
```
public/uploads/subscriptions/
  └─ 2025000524/           # 분양번호
      ├─ gallery/
      ├─ floorplan/
      ├─ layout/
      └─ ...
```

**배포용 경로**:
```
public/images/subscriptions/
  └─ 용인 푸르지오 원클러스터파크/  # 현장명
      ├─ gallery/
      ├─ floorplan/
      ├─ layout/
      └─ ...
```

## 🛠️ 해결 과정

### 1단계: 배포 제외 설정 (.vercelignore)

**파일**: `.vercelignore`
```
# 크롤링한 원본 이미지 전체 제외 (배포 안 함)
public/uploads/subscriptions/

# 선별된 이미지만 배포 (public/images/subscriptions/ 는 포함됨)
```

**목적**: 원본 크롤링 이미지는 로컬에만 보관, 배포 제외

---

### 2단계: DB 이미지 복사 스크립트

**파일**: `scripts/copy-selected-images.mjs`

**기능**:
1. DB에서 실제 사용 중인 이미지 목록 조회
2. `public/uploads/subscriptions/` → `public/images/subscriptions/` 복사
3. 폴더명: 분양번호 → 현장명 (한글)
4. 카테고리 폴더 구조 유지 (gallery, floorplan 등)
5. DB URL 업데이트: `/uploads/` → `/images/`

**실행 결과**:
```bash
✅ 성공: 4,595개
❌ 실패: 0개
📁 대상 폴더: public/images/subscriptions
```

**핵심 로직**:
```javascript
// 1. DB 조회
const images = await prisma.subscriptionImage.findMany({
  include: {
    subscription: {
      select: { houseManageNo, houseName }
    }
  }
});

// 2. 현장명으로 폴더 생성
const folderName = sanitizeFolderName(subscription.houseName);
const categoryFolder = getCategoryFolder(image.category);

// 3. 경로 구성
// 원본: /uploads/subscriptions/2025000524/gallery/main.jpg
// 복사: /images/subscriptions/용인 푸르지오 원클러스터파크/gallery/main.jpg
```

---

### 3단계: API 수정 (파일시스템 → DB 기반)

**문제 발견**:
- `.vercelignore`로 `/uploads/` 제외 → 사이트에서 이미지 0개 표시
- 기존 API가 파일시스템을 직접 스캔하고 있었음

**해결 방법**: API를 DB 기반으로 변경

**파일**: `src/app/api/subscriptions/[id]/images/route.ts`

**변경 전 (파일시스템 스캔)**:
```typescript
// ❌ 문제: 파일시스템 스캔
const subscriptionDir = path.join(process.cwd(), 'public', 'uploads', 'subscriptions', id);
const files = fs.readdirSync(catDir);
```

**변경 후 (DB 조회)**:
```typescript
// ✅ 해결: DB에서 조회
const subscription = await prisma.subscription.findUnique({
  where: { houseManageNo: id },
  include: { images: true }
});

// 카테고리별 그룹화
for (const image of subscription.images) {
  categoryMap.set(category, image.url);
}
```

**장점**:
- ✅ DB에 저장된 이미지만 표시
- ✅ 배포 시 파일시스템 구조 무관
- ✅ `.vercelignore`와 충돌 없음

---

## 📊 현재 상태

### 이미지 통계
```
총 청약 수: ~170개
총 이미지: 4,595개
배포 용량: 1.7GB

카테고리별 분포:
- GALLERY: 3,591개 (78%)
- FLOORPLAN: 414개 (9%)
- PREMIUM: 279개 (6%)
- LOCATION: 173개 (4%)
- LAYOUT: 106개 (2%)
- UNIT_LAYOUT: 16개
- COMMUNITY: 16개
```

### 배포 용량 분석
```
현재: 1.7GB (4,595개 이미지 전체)
Vercel 제한: 없음 (함수는 300MB, 정적 파일은 제한 없음)
```

**참고**: Vercel은 정적 파일(이미지)에는 용량 제한이 없고, 서버리스 함수만 300MB 제한이 있음.

---

## ✅ 완료된 작업

1. ✅ `.vercelignore` 설정 (원본 이미지 제외)
2. ✅ `copy-selected-images.mjs` 스크립트 작성
3. ✅ DB 이미지 복사 완료 (4,595개)
4. ✅ 폴더명 현장명으로 변경 (한글)
5. ✅ 카테고리 폴더 구조 유지
6. ✅ DB URL 업데이트 완료
7. ✅ API를 DB 기반으로 변경

---

## 🔄 향후 작업 옵션

### 옵션 1: 현재 상태로 배포
- **장점**: 모든 이미지 즉시 사용 가능
- **단점**: 1.7GB 배포 (초기 배포 시간 증가)
- **적합**: Vercel Pro 플랜 (무제한 대역폭)

### 옵션 2: 이미지 수 최적화
- **방법**: 청약당 대표 이미지 5~10개만 남기기
- **예상 감소**: 4,595개 → ~1,000개 (약 400MB)
- **장점**: 빠른 배포, 적은 용량
- **단점**: 일부 이미지 누락 가능

### 옵션 3: CDN 이전 (장기 계획)
- **방법**: Cloudflare R2, AWS S3 등 사용
- **장점**: 무제한 저장, 빠른 속도
- **단점**: 추가 설정 필요, 약간의 비용

---

## 🗂️ 관련 파일

### 스크립트
- `scripts/copy-selected-images.mjs` - DB 이미지 복사
- `scripts/check-db-images.mjs` - DB 이미지 통계 확인

### API
- `src/app/api/subscriptions/[id]/images/route.ts` - 이미지 조회 API (DB 기반)

### 설정
- `.vercelignore` - 배포 제외 파일 설정

### 데이터베이스
- `prisma/schema.prisma` - SubscriptionImage 모델
  - `id`, `url`, `category`, `order`, `subscriptionId`

---

## 📝 참고 사항

### 윈도우 파일명 제한 처리
```javascript
function sanitizeFolderName(houseName) {
  return houseName
    .replace(/[<>:"/\\|?*]/g, '') // 윈도우 금지 문자 제거
    .replace(/\s+/g, ' ')          // 연속 공백 → 단일 공백
    .trim();
}
```

### 카테고리 매핑
```javascript
const categoryMap = {
  'GALLERY': 'gallery',
  'FLOORPLAN': 'floorplan',
  'LAYOUT': 'layout',
  'UNIT_LAYOUT': 'unit-layout',
  'LOCATION': 'location',
  'MODELHOUSE': 'modelhouse',
  'PREMIUM': 'premium',
  'COMMUNITY': 'community',
  'NOTICE_PDF': 'notice',
};
```

---

*최종 수정일: 2025-12-21*
*작성자: 온비스 (ONBIS)*
