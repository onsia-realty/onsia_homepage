// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

// 사용자 및 관리자
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  role      UserRole @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 작성한 게시글
  posts Post[]

  // 등록한 매물
  properties Property[]

  // 매물 문의
  inquiries PropertyInquiry[]

  // NextAuth.js 관련 필드
  accounts Account[]
  sessions Session[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// 게시글 (뉴스, 부동산 정보)
model Post {
  id          String      @id @default(cuid())
  title       String
  slug        String      @unique
  content     String
  excerpt     String?
  category    PostCategory
  status      PostStatus  @default(DRAFT)
  featuredImage String?
  
  // SEO 관련
  seoTitle       String?
  seoDescription String?
  
  // 메타데이터
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // 관계
  authorId String
  author   User   @relation(fields: [authorId], references: [id])
  
  // 태그
  tags PostTag[]
}

// 태그
model Tag {
  id    String @id @default(cuid())
  name  String @unique
  color String?
  
  posts PostTag[]
}

model PostTag {
  postId String
  tagId  String
  
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@id([postId, tagId])
}

// 유튜브 영상
model Video {
  id            String   @id @default(cuid())
  youtubeId     String   @unique
  title         String
  description   String?
  thumbnail     String
  duration      String?
  publishedAt   DateTime
  category      String?
  tags          String   // JSON string
  viewCount     Int?     @default(0)
  likeCount     Int?     @default(0)
  commentCount  Int?     @default(0)
  
  // 메타데이터
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // SEO 관련
  seoTitle       String?
  seoDescription String?
}

// 회사 정보
model Company {
  id            String   @id @default(cuid())
  name          String
  description   String
  mission       String?
  vision        String?
  
  // JSON 필드들
  patents       String   // JSON string
  achievements  String   // JSON string  
  teamMembers   String   // JSON string
  
  // 메타데이터
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

// 건설사 정보
model Developer {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  logoUrl     String?
  website     String?

  // 실적
  totalProjects Int?     @default(0)
  rating        Float?   @default(0)

  // 메타데이터
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 관계
  properties Property[]
}

// 분양권 매물
model Property {
  id            String         @id @default(cuid())
  title         String
  slug          String         @unique
  description   String

  // 위치 정보
  address       String
  district      String
  city          String
  zipCode       String?

  // 기본 정보
  totalUnits    Int
  availableUnits Int           @default(0)
  buildingType  BuildingType
  completionDate DateTime
  moveInDate    DateTime?

  // 가격 정보 (원 단위)
  basePrice     BigInt
  priceDisplay  String?        // 표시용 가격 (예: "4억~7억", "5억대")
  pricePerPyeong BigInt?
  contractDeposit BigInt
  interimPayments String       // JSON string for payment schedule

  // 분양권 특화 정보
  rightsFee     BigInt?        // 권리금 (사용안함)
  profitRate    Float?         // 예상 수익률 (사용안함)
  investmentGrade String?      // 투자 등급
  constructor   String?        // 시공사
  keyFeature    String?        // 특장점 (한 줄 요약)
  keyFeatures   String?        // 특장점 목록 JSON (여러 개)
  loanRatio     String?        // 중도금 대출 비율 (예: "60% 무이자")

  // 단지 정보
  totalBuildingCount Int?
  parkingSpaces     Int?
  facilities        String     // JSON string

  // 상태
  status        PropertyStatus @default(AVAILABLE)
  featured      Boolean       @default(false)

  // 신규 추가 필드 (2024-12)
  pdfUrl        String?       // 교육자료 PDF 링크
  youtubeVideoId String?      // 현장 소개 유튜브 영상 ID
  locationDesc  String?       // 위치 설명 (역세권, 학군, 교통 등)
  pyeongTypes   String?       // 평형 구성 JSON (["59A", "84B", "114C"])
  subdomain     String?       @unique // 프리미엄 현장 서브도메인
  isPremium     Boolean       @default(false) // 프리미엄 현장 여부

  // SEO
  seoTitle      String?
  seoDescription String?

  // 메타데이터
  viewCount     Int           @default(0)
  inquiryCount  Int           @default(0)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  publishedAt   DateTime?

  // 관계
  developerId   String
  developer     Developer     @relation(fields: [developerId], references: [id])

  authorId      String
  author        User          @relation(fields: [authorId], references: [id])

  images        PropertyImage[]
  inquiries     PropertyInquiry[]
  investments   Investment[]

  @@index([status, featured])
  @@index([district, city])
  @@index([basePrice])
}

// 매물 이미지
model PropertyImage {
  id          String      @id @default(cuid())
  url         String
  alt         String?
  caption     String?
  order       Int         @default(0)
  type        ImageType   @default(EXTERIOR)

  // 메타데이터
  createdAt   DateTime    @default(now())

  // 관계
  propertyId  String
  property    Property    @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId, order])
}

// 매물 문의
model PropertyInquiry {
  id          String        @id @default(cuid())
  name        String
  email       String
  phone       String?
  message     String
  inquiryType InquiryType   @default(GENERAL)
  status      InquiryStatus @default(PENDING)
  source      String?       // 유입 경로 (google, direct, sns 등)

  // 메타데이터
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  respondedAt DateTime?

  // 관계
  propertyId  String
  property    Property      @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  userId      String?
  user        User?         @relation(fields: [userId], references: [id])

  @@index([status, createdAt])
}

// 투자 분석
model Investment {
  id                String   @id @default(cuid())
  currentValue      BigInt
  projectedValue    BigInt
  profitAmount      BigInt
  profitRate        Float
  investmentPeriod  Int      // 개월 수
  riskLevel        String   // LOW, MEDIUM, HIGH
  marketAnalysis   String   // JSON string

  // 메타데이터
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // 관계
  propertyId       String
  property         Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
}


// Enums
enum UserRole {
  USER
  ADMIN
}

enum PostCategory {
  NEWS
  REAL_ESTATE
  AI_TECH
  BLOCKCHAIN
  MARKET_ANALYSIS
}

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum PropertyStatus {
  AVAILABLE
  SOLD_OUT
  COMING_SOON
  SUSPENDED
}

enum BuildingType {
  APARTMENT           // 아파트
  OFFICETEL           // 오피스텔
  KNOWLEDGE_INDUSTRY  // 지식산업센터
  COMMERCIAL          // 상가
  SPECIAL             // 특수물건
  VILLA               // 빌라 (레거시)
  TOWNHOUSE           // 타운하우스 (레거시)
}

enum ImageType {
  EXTERIOR
  INTERIOR
  FLOOR_PLAN
  SITE_PLAN
  AMENITY
}

enum InquiryType {
  GENERAL
  VIEWING
  INVESTMENT
  CONSULTATION
}

enum InquiryStatus {
  PENDING
  RESPONDED
  CLOSED
}

// ==========================================
// 경매 관련 모델
// ==========================================

// 경매 물건
model AuctionItem {
  id                String   @id @default(cuid())

  // 식별자
  caseNumber        String   @unique  // 2025타경8255
  caseNumberFull    String?           // 20250130008255
  courtCode         String?           // 2110
  courtName         String?           // 대구지방법원
  pnu               String?           // 19자리 필지고유번호

  // 기본정보
  address           String
  addressDetail     String?
  city              String
  district          String
  itemType          AuctionItemType
  landArea          Float?            // 대지면적 (㎡)
  buildingArea      Float?            // 건물면적 (㎡)
  floor             String?           // 층수
  totalFloors       String?           // 총 층수 (예: "51층")
  buildingStructure String?           // 구조 (철근콘크리트, 철골 등)
  buildingUsage     String?           // 용도 (오피스텔, 아파트 등)
  landUseZone       String?           // 토지이용계획 (주상혼용지역 등)

  // 감정평가 정보
  appraisalOrg      String?           // 감정기관 (대한감정원, 한국감정원 등)
  appraisalDate     DateTime?         // 가격시점
  preservationDate  DateTime?         // 보존등기일
  approvalDate      DateTime?         // 사용승인일
  landAppraisalPrice   BigInt?        // 토지 감정가
  buildingAppraisalPrice BigInt?      // 건물 감정가

  // 가격정보
  appraisalPrice    BigInt            // 감정가 합계
  minimumPrice      BigInt            // 최저가
  minimumRate       Int?              // 최저가율 (%)
  deposit           BigInt?           // 보증금 (10%)

  // 일정
  saleDate          DateTime?         // 매각기일
  saleTime          String?           // 매각시간
  bidCount          Int      @default(0)  // 입찰횟수 (회차)
  bidEndDate        DateTime?         // 배당요구종기일

  // 권리분석
  referenceDate     DateTime?         // 말소기준일
  hasRisk           Boolean  @default(false)  // 위험물건 여부
  riskNote          String?           // 위험 사유

  // 당사자
  owner             String?           // 소유자
  debtor            String?           // 채무자
  creditor          String?           // 채권자

  // 상태
  status            AuctionStatus @default(SCHEDULED)
  featured          Boolean  @default(false)

  // 현황/위치 정보
  surroundings      String?           // 주변환경 설명
  transportation    String?           // 교통 정보
  nearbyFacilities  String?           // 근린시설 (백화점, 학교 등)
  heatingType       String?           // 난방방식 (도시가스, 중앙난방 등)
  facilities        String?           // 편의시설 JSON (승강기, 에어컨, 주차장 등)
  locationNote      String?           // 위치 특이사항

  // 외부 데이터
  realPrice         BigInt?           // 실거래가 (국토부 API)
  buildingInfo      String?           // 건축물대장 JSON
  naverComplexId    String?           // 네이버 단지 ID

  // SEO
  seoTitle          String?
  seoDescription    String?

  // 메타데이터
  viewCount         Int      @default(0)
  inquiryCount      Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // 관계
  bids              AuctionBid[]
  registers         AuctionRegister[]
  tenants           AuctionTenant[]
  images            AuctionImage[]

  @@index([status, saleDate])
  @@index([city, district])
  @@index([itemType])
  @@index([pnu])
}

// 입찰 내역
model AuctionBid {
  id            String   @id @default(cuid())
  itemId        String
  item          AuctionItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  round         Int               // 회차
  bidDate       DateTime?         // 입찰일
  minimumPrice  BigInt            // 최저가
  result        AuctionBidResult  // 유찰/낙찰/취하
  winningPrice  BigInt?           // 낙찰가 (낙찰 시)
  bidderCount   Int?              // 입찰자수

  createdAt     DateTime @default(now())

  @@index([itemId, round])
}

// 등기 내역
model AuctionRegister {
  id            String   @id @default(cuid())
  itemId        String
  item          AuctionItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  registerType  String?           // 갑/을
  registerNo    String?           // 순위번호
  receiptDate   DateTime?         // 접수일
  purpose       String?           // 등기목적 (근저당권설정, 압류 등)
  rightHolder   String?           // 권리자
  claimAmount   BigInt?           // 채권금액
  isReference   Boolean  @default(false)  // 말소기준등기 여부
  willExpire    Boolean  @default(true)   // 소멸여부
  note          String?           // 비고

  createdAt     DateTime @default(now())

  @@index([itemId])
}

// 임차인 현황
model AuctionTenant {
  id            String   @id @default(cuid())
  itemId        String
  item          AuctionItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  tenantName    String?           // 임차인명 (마스킹)
  hasPriority   Boolean?          // 대항력 유무
  occupiedPart  String?           // 점유부분
  moveInDate    DateTime?         // 전입일
  fixedDate     DateTime?         // 확정일자
  hasBidRequest Boolean?          // 배당요구 여부
  deposit       BigInt?           // 보증금
  monthlyRent   BigInt?           // 차임
  analysis      String?           // 분석결과
  note          String?           // 비고

  createdAt     DateTime @default(now())

  @@index([itemId])
}

// 경매 이미지
model AuctionImage {
  id          String   @id @default(cuid())
  itemId      String
  item        AuctionItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  imageType   AuctionImageType     // 사진/현황조사서/감정평가서
  url         String               // 저장된 URL
  originalUrl String?              // 원본 URL
  alt         String?
  order       Int      @default(0)

  createdAt   DateTime @default(now())

  @@index([itemId, order])
}

// 경매 관련 Enums
enum AuctionItemType {
  APARTMENT       // 아파트
  VILLA           // 빌라/연립
  OFFICETEL       // 오피스텔
  HOUSE           // 단독주택
  COMMERCIAL      // 상가
  LAND            // 토지
  FACTORY         // 공장
  BUILDING        // 건물일괄
  OTHER           // 기타
}

enum AuctionStatus {
  SCHEDULED       // 매각예정
  BIDDING         // 입찰중
  SUCCESSFUL      // 낙찰
  FAILED          // 유찰
  WITHDRAWN       // 취하
  CANCELED        // 취소
}

enum AuctionBidResult {
  FAILED          // 유찰
  SUCCESSFUL      // 낙찰
  WITHDRAWN       // 취하
  POSTPONED       // 연기
}

enum AuctionImageType {
  PHOTO           // 물건사진
  SURVEY          // 현황조사서
  APPRAISAL       // 감정평가서
  REGISTER        // 등기부
  OTHER           // 기타
}

// ==================== 청약 (Subscription) ====================

// 청약 분양 정보
model Subscription {
  id                String   @id @default(cuid())

  // 청약홈 식별자
  houseManageNo     String   @unique              // 주택관리번호 (HOUSE_MANAGE_NO)
  pblancNo          String                        // 공고번호 (PBLANC_NO)
  asilId            String?                       // 아실(ASIL) 분양번호 (청약홈과 다를 수 있음)

  // 기본 정보
  houseName         String                        // 주택명 (HOUSE_NM)
  houseType         String                        // 주택구분 (HOUSE_SECD_NM: APT/오피스텔)
  houseDetailType   String                        // 주택상세구분 (HOUSE_DTL_SECD_NM: 민영/공공)

  // 주소 정보
  address           String                        // 공급위치 (HSSPLY_ADRES)
  addressDetail     String?                       // 상세주소
  zipCode           String?                       // 우편번호 (HSSPLY_ZIP)
  region            String                        // 지역 (SUBSCRPT_AREA_CODE_NM)
  regionCode        String?                       // 지역코드 (SUBSCRPT_AREA_CODE)

  // 좌표 (지오코딩)
  latitude          Float?                        // 위도
  longitude         Float?                        // 경도

  // 공급 정보
  totalHouseholds   Int                           // 총공급세대수 (TOT_SUPLY_HSHLDCO)

  // 일정
  recruitDate       DateTime?                     // 모집공고일 (RCRIT_PBLANC_DE)
  receptionStart    DateTime?                     // 청약접수 시작일 (RCEPT_BGNDE)
  receptionEnd      DateTime?                     // 청약접수 종료일 (RCEPT_ENDDE)
  specialSupplyDate DateTime?                     // 특별공급 접수일 (SPSPLY_RCEPT_BGNDE)
  rank1Date         DateTime?                     // 일반공급 1순위 접수일 (GNRL_RNK1_CRSPAREA_RCPTDE)
  rank2Date         DateTime?                     // 일반공급 2순위 접수일 (GNRL_RNK2_CRSPAREA_RCPTDE)
  winnerAnnouncementDate DateTime?                // 당첨자발표일 (PRZWNER_PRESNATN_DE)
  contractStart     DateTime?                     // 계약 시작일 (CNTRCT_CNCLS_BGNDE)
  contractEnd       DateTime?                     // 계약 종료일 (CNTRCT_CNCLS_ENDDE)
  moveInDate        String?                       // 입주예정년월 (MVN_PREARNGE_YM: YYYYMM)

  // 건설사 정보
  developer         String?                       // 시공사 (CNSTRCT_ENTRPS_NM)
  contractor        String?                       // 사업주체 (BSNS_MBY_NM)

  // 연락처
  modelHousePhone   String?                       // 모델하우스 전화번호 (MDHS_TELNO)
  homepage          String?                       // 홈페이지 (HMPG_ADRES)
  noticeUrl         String?                       // 청약홈 URL (PBLANC_URL)

  // 가격 정보 (계산된 값)
  avgPrice          Int?                          // 평균분양가 (만원)
  avgPricePerPyeong Int?                          // 평균평당가 (만원)
  minPrice          Int?                          // 최저분양가 (만원)
  maxPrice          Int?                          // 최고분양가 (만원)

  // 상태
  status            SubscriptionStatus @default(UPCOMING)
  isHot             Boolean @default(false)       // 인기 매물 여부
  viewCount         Int     @default(0)           // 조회수

  // 메타데이터
  rawData           Json?                         // 원본 API 응답 데이터
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // 관계
  images            SubscriptionImage[]
  housingTypes      SubscriptionHousingType[]

  @@index([houseManageNo])
  @@index([status])
  @@index([region])
  @@index([receptionStart])
}

// 청약 이미지
model SubscriptionImage {
  id              String   @id @default(cuid())
  subscriptionId  String
  subscription    Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  category        SubscriptionImageCategory      // 이미지 카테고리
  url             String                          // 이미지 URL
  originalUrl     String?                         // 원본 URL (아실)
  alt             String?
  order           Int      @default(0)

  createdAt       DateTime @default(now())

  @@index([subscriptionId, category, order])
}

// 청약 주택형 정보
model SubscriptionHousingType {
  id              String   @id @default(cuid())
  subscriptionId  String
  subscription    Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  // 주택형 정보
  houseTy         String                          // 주택형 (HOUSE_TY: 084.8950A)
  modelNo         String?                         // 모델번호
  supplyArea      Float                           // 공급면적 (㎡)
  exclusiveArea   Float?                          // 전용면적 (㎡)

  // 세대수
  totalHouseholds Int                             // 총세대수
  generalHouseholds Int                           // 일반분양세대수
  specialHouseholds Int                           // 특별공급세대수

  // 가격
  topPrice        Int?                            // 최고분양가 (만원)
  pricePerPyeong  Int?                            // 평당가 (만원)

  // 메타데이터
  rawData         Json?                           // 원본 API 응답 데이터
  createdAt       DateTime @default(now())

  @@index([subscriptionId])
  @@unique([subscriptionId, houseTy])
}

// 청약 관련 Enums
enum SubscriptionStatus {
  UPCOMING        // 접수예정
  OPEN            // 접수중
  CLOSED          // 접수마감
  ANNOUNCED       // 당첨자발표
  CONTRACTED      // 계약진행중
  COMPLETED       // 완료
}

enum SubscriptionImageCategory {
  MODELHOUSE      // 모델하우스 위치 (카테고리 2)
  LOCATION        // 입지환경 (카테고리 3)
  LAYOUT          // 단지배치도 (카테고리 4)
  UNIT_LAYOUT     // 동호수배치표 (카테고리 5)
  FLOORPLAN       // 면적표/평면도 (카테고리 6)
  GALLERY         // 사진갤러리 (카테고리 9)
  NOTICE_PDF      // 모집공고문 PDF
  PREMIUM         // 프리미엄/특장점
  COMMUNITY       // 커뮤니티/편의시설
}
