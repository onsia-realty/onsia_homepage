# 청약 정보 크롤링 시스템

## 📋 개요

청약 데이터를 자동으로 수집하고 DB에 저장하는 크롤링 시스템입니다.

## 🔄 크롤링 파이프라인

```
청약홈 API → 기본 정보 → 공식 홈페이지 → 고품질 이미지 → 실거래가 API → DB 저장
```

---

## 1️⃣ 청약홈 API 크롤러

### 스크립트
`scripts/crawl-subscriptions.mjs`

### 기능
- 청약홈 공공데이터 API에서 분양 정보 수집
- Kakao Map API로 좌표 변환 (주소 → 위도/경도)
- 평균 분양가 자동 계산
- Prisma로 DB 저장

### 사용법
```bash
node scripts/crawl-subscriptions.mjs
```

### 수집 데이터
**Subscription 테이블**:
- `houseManageNo`: 청약홈 분양번호 (고유 ID)
- `houseName`: 주택명
- `address`: 공급위치
- `totalHouseholds`: 총공급세대수
- `recruitDate`: 모집공고일
- `receptionStart/End`: 청약접수 기간
- `moveInDate`: 입주예정년월
- `developer`: 시공사
- `homepage`: 공식 홈페이지 URL

**SubscriptionHousingType 테이블**:
- `houseTy`: 주택형 (예: 084.8950A)
- `supplyArea`: 공급면적 (㎡)
- `exclusiveArea`: 전용면적 (㎡)
- `totalHouseholds`: 총세대수
- `topPrice`: 최고분양가 (만원)
- `pricePerPyeong`: 평당가 (만원)

### 결과
- Subscription 테이블에 기본 정보 저장
- SubscriptionHousingType 테이블에 주택형별 정보 저장

---

## 2️⃣ 범용 홈페이지 크롤러 v3 (권장 ⭐)

### 스크립트
`scripts/crawl-homepage-universal.mjs`

### 핵심 전략

청약 단지 공식 홈페이지는 항상 다음 구조를 따름:

1. **메인 페이지 로딩**: 동영상 팝업 → 10초 대기 → 팝업 자동 닫기
2. **헤더 메뉴 구조**: 왼쪽부터 순서대로 (사업안내 → 단지안내 → 세대안내 → 분양안내 등)
3. **이미지 소스**: F12 소스 코드에 항상 이미지 URL 존재

### 크롤링 프로세스

```
1. 메인 페이지 로딩 (10초 대기)
   └─ 팝업 자동 닫기 (동영상, 광고 등)

2. 헤더 메뉴 수집 (왼쪽부터 순서대로)
   └─ 텍스트 무관, 위치 기반 수집
   └─ 건설사마다 표현 다름 (사업안내/사업개요/사업소개)

3. 각 페이지 방문
   └─ F12 소스에서 이미지 URL 정규식 추출
   └─ img 태그 + HTML 소스 패턴 매칭

4. 이미지 다운로드
   └─ Playwright request API 사용
   └─ 실패시 브라우저 fetch 폴백
   └─ 파일 크기 검증 (1KB 이하 제외)

5. 자동 카테고리 분류
   └─ 파일명/URL 기반 키워드 매칭
   └─ 평면도, 단지배치도, 동호수표, 프리미엄, 입지환경, 커뮤니티
```

### 왜 텍스트 매칭이 아닌가?

- ❌ 건설사마다 표현 다름: "사업안내" vs "사업개요" vs "사업소개"
- ❌ 텍스트 약간만 달라도 크롤링 실패
- ✅ 헤더 메뉴는 항상 왼쪽부터 순서대로 배치
- ✅ 위치 기반 수집으로 범용성 확보

### 사용법

```bash
# 1. 이미지 다운로드
node scripts/crawl-homepage-universal.mjs 2025000524

# 2. DB에 저장
node scripts/save-homepage-images.mjs 2025000524
```

### 장점

- ✅ 모든 건설사 홈페이지 범용 지원
- ✅ 고품질 공식 이미지 (1100~1408px)
- ✅ 평면도, 배치도, 동호수표 등 전체 자료
- ✅ F12 소스 기반으로 숨겨진 이미지도 수집
- ✅ 건설사 공식 인증 이미지

### 수집 이미지 카테고리

- `MODELHOUSE`: 모델하우스 위치
- `LOCATION`: 입지환경
- `LAYOUT`: 단지배치도
- `UNIT_LAYOUT`: 동호수배치표
- `FLOORPLAN`: 평면도
- `GALLERY`: 사진갤러리
- `NOTICE_PDF`: 모집공고문
- `PREMIUM`: 프리미엄/특장점
- `COMMUNITY`: 커뮤니티/편의시설

### 결과

- `public/uploads/subscriptions/{분양번호}/` 디렉토리에 이미지 저장
- `crawl-result-homepage.json` 메타데이터 생성
- SubscriptionImage 테이블에 DB 저장

---

## 3️⃣ 실거래가 API 통합

### 개요

국토교통부 실거래가 API를 활용하여 청약 단지 주변 시세를 비교하는 기능입니다.

### 주요 기능

1. **국토교통부 실거래가 API 클라이언트**
   - 아파트 실거래가 조회
   - 지역/기간별 필터링

2. **주변 단지 시세 비교**
   - 청약 단지 반경 내 거래 사례 수집
   - 분양가 대비 시세차 자동 계산
   - 평당가 비교 분석

3. **API 엔드포인트**
   - `GET /api/subscriptions/:id/compare` - 주변 시세 비교 데이터 제공

### 데이터 흐름

```
청약 단지 위치 정보 (위도/경도)
  ↓
국토교통부 실거래가 API 호출
  ↓
주변 아파트 거래 데이터 수집
  ↓
분양가 대비 시세차 계산
  ↓
프론트엔드에 시각화
```

### 환경 변수

```env
# 공공데이터포털 API (청약홈 + 실거래가 공용)
DATA_GO_KR_API_KEY="your-api-key-here"
```

---

## 🚀 크롤링 워크플로우

### 신규 청약 단지 추가 시

```bash
# 1단계: 청약홈에서 기본 정보 수집
node scripts/crawl-subscriptions.mjs

# 2단계: 공식 홈페이지에서 이미지 수집
node scripts/crawl-homepage-universal.mjs 2025000524

# 3단계: 이미지 DB 저장
node scripts/save-homepage-images.mjs 2025000524
```

### 실행 순서 설명

1. **청약홈 API 크롤링**
   - 청약홈에서 신규 분양 정보 가져오기
   - DB에 기본 정보 저장
   - `houseManageNo`, `homepage` URL 확보

2. **공식 홈페이지 이미지 크롤링**
   - 저장된 `homepage` URL로 접속
   - Playwright로 페이지 자동화
   - 이미지 다운로드 및 분류

3. **DB 저장**
   - 다운로드된 이미지를 SubscriptionImage 테이블에 저장
   - 카테고리별로 정렬 및 인덱싱

---

## 💾 DB 스키마

### Subscription 모델 주요 필드

| 필드명 | 타입 | 설명 |
|--------|------|------|
| `houseManageNo` | String | 청약홈 분양번호 (고유 ID) |
| `asilId` | String? | 아실 분양번호 (청약홈과 다를 수 있음) |
| `homepage` | String? | 공식 홈페이지 URL (크롤링 대상) |
| `houseName` | String | 주택명 |
| `address` | String | 공급위치 |
| `latitude` | Float? | 위도 (Kakao Map API) |
| `longitude` | Float? | 경도 (Kakao Map API) |
| `totalHouseholds` | Int | 총공급세대수 |
| `developer` | String? | 시공사 |
| `avgPrice` | Int? | 평균분양가 (만원) |
| `avgPricePerPyeong` | Int? | 평균평당가 (만원) |

### SubscriptionImage 모델

| 필드명 | 타입 | 설명 |
|--------|------|------|
| `subscriptionId` | String | 청약 ID (FK) |
| `category` | Enum | 이미지 카테고리 |
| `url` | String | 이미지 URL |
| `order` | Int | 정렬 순서 |

### SubscriptionHousingType 모델

| 필드명 | 타입 | 설명 |
|--------|------|------|
| `subscriptionId` | String | 청약 ID (FK) |
| `houseTy` | String | 주택형 (084.8950A) |
| `supplyArea` | Float | 공급면적 (㎡) |
| `exclusiveArea` | Float? | 전용면적 (㎡) |
| `topPrice` | Int? | 최고분양가 (만원) |
| `pricePerPyeong` | Int? | 평당가 (만원) |

---

## 🔧 환경 설정

### 필수 환경 변수

```env
# 공공데이터포털 API (청약홈 + 실거래가)
DATA_GO_KR_API_KEY="your-api-key-here"

# 카카오 지도 API
KAKAO_REST_API_KEY="your-kakao-rest-api-key"

# Database
DATABASE_URL="postgresql://..."
```

### API 키 발급

1. **공공데이터포털**: https://www.data.go.kr
   - 청약홈 API
   - 아파트 실거래가 API

2. **카카오 개발자**: https://developers.kakao.com
   - REST API 키 (주소→좌표 변환용)

---

## ⚠️ Deprecated: 아실(ASIL) 이미지 크롤러

### 스크립트
`scripts/crawl-asil-images.mjs` **(사용 중단)**

### 문제점
- ❌ 청약홈 분양번호 ≠ 아실 분양번호 (ID 매핑 필요)
- ❌ 제한적인 이미지 (모델하우스, 위치, 갤러리만)
- ❌ 중간 해상도 (아실 자체 이미지)

### 권장 사항
**공식 홈페이지 크롤러 사용** (범용성, 고품질, 전체 자료)

---

## 📊 성능 및 통계

### 크롤링 속도
- 청약홈 API: ~5초/건
- 공식 홈페이지: ~30-60초/건 (이미지 개수에 따라 변동)
- 실거래가 API: ~2초/조회

### 수집 데이터 규모
- 청약 단지: 수백 건
- 주택형: 단지당 평균 5-10개
- 이미지: 단지당 평균 30-50장

---

*최종 업데이트: 2025-01-09*
