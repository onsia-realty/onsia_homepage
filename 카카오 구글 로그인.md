# Next.js 카카오/구글 소셜 로그인 구현 가이드

## 개요
NextAuth.js v4 + Prisma를 사용한 소셜 로그인 구현 가이드

## 1. 패키지 설치

```bash
npm install next-auth @next-auth/prisma-adapter
```

**주의**: `@auth/prisma-adapter`는 NextAuth v5용이므로 v4에서는 `@next-auth/prisma-adapter` 사용

## 2. Prisma 스키마

```prisma
model User {
  id            String    @id @default(cuid())
  email         String?   @unique
  emailVerified DateTime?
  name          String?
  image         String?
  role          UserRole  @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  accounts      Account[]
  sessions      Session[]
}

model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?
  access_token             String?
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?
  session_state            String?
  refresh_token_expires_in Int?    // 카카오 필수!
  user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
```

**중요**: 카카오는 `refresh_token_expires_in` 필드를 반환하므로 Account 모델에 반드시 추가해야 함!

## 3. 환경변수 (.env)

```env
# NextAuth
NEXTAUTH_SECRET="your-secret-key-here"
NEXTAUTH_URL="http://localhost:3000"

# Google OAuth
GOOGLE_CLIENT_ID="your-google-client-id"
GOOGLE_CLIENT_SECRET="your-google-client-secret"

# Kakao OAuth
KAKAO_CLIENT_ID="your-kakao-rest-api-key"
KAKAO_CLIENT_SECRET="your-kakao-client-secret"
```

## 4. NextAuth API 라우트

파일: `src/app/api/auth/[...nextauth]/route.ts`

```typescript
import NextAuth, { NextAuthOptions } from "next-auth";
import GoogleProvider from "next-auth/providers/google";
import KakaoProvider from "next-auth/providers/kakao";
import { PrismaAdapter } from "@next-auth/prisma-adapter";
import { PrismaClient } from "@prisma/client";

const prisma = new PrismaClient();

export const authOptions: NextAuthOptions = {
  adapter: PrismaAdapter(prisma),
  providers: [
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
      allowDangerousEmailAccountLinking: true,
    }),
    KakaoProvider({
      clientId: process.env.KAKAO_CLIENT_ID!,
      clientSecret: process.env.KAKAO_CLIENT_SECRET!,
      allowDangerousEmailAccountLinking: true,
    }),
  ],
  callbacks: {
    async session({ session, user }) {
      if (session.user) {
        session.user.id = user.id;
        session.user.role = (user as any).role;
      }
      return session;
    },
  },
  pages: {
    signIn: "/auth/signin",
    error: "/auth/error",
  },
  secret: process.env.NEXTAUTH_SECRET,
  debug: process.env.NODE_ENV === "development",
};

const handler = NextAuth(authOptions);
export { handler as GET, handler as POST };
```

## 5. SessionProvider 설정

파일: `src/components/auth/SessionProvider.tsx`

```typescript
"use client";

import { SessionProvider as NextAuthSessionProvider } from "next-auth/react";

export default function SessionProvider({
  children,
}: {
  children: React.ReactNode;
}) {
  return <NextAuthSessionProvider>{children}</NextAuthSessionProvider>;
}
```

파일: `src/app/layout.tsx`에서 감싸기

```typescript
import SessionProvider from "@/components/auth/SessionProvider";

export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        <SessionProvider>
          {children}
        </SessionProvider>
      </body>
    </html>
  );
}
```

## 6. 로그인 페이지

파일: `src/app/auth/signin/page.tsx`

```typescript
"use client";

import { signIn } from "next-auth/react";
import { useSearchParams } from "next/navigation";

export default function SignInPage() {
  const searchParams = useSearchParams();
  const callbackUrl = searchParams.get("callbackUrl") || "/";
  const error = searchParams.get("error");

  return (
    <div>
      <h1>로그인</h1>
      {error && <p>로그인에 실패했습니다.</p>}

      <button onClick={() => signIn("google", { callbackUrl })}>
        구글로 시작하기
      </button>

      <button onClick={() => signIn("kakao", { callbackUrl })}>
        카카오로 시작하기
      </button>
    </div>
  );
}
```

## 7. 미들웨어 (로그인 필요 페이지 보호)

파일: `src/middleware.ts`

```typescript
import { getToken } from 'next-auth/jwt';
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

const protectedPaths = [
  '/mypage',
  '/subscription/[^/]+$',  // 상세 페이지만
];

export async function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl;

  let isProtected = false;
  for (const pattern of protectedPaths) {
    if (new RegExp(pattern).test(pathname)) {
      isProtected = true;
      break;
    }
  }

  if (!isProtected) return NextResponse.next();

  const token = await getToken({
    req: request,
    secret: process.env.NEXTAUTH_SECRET,
  });

  if (!token) {
    const signInUrl = new URL('/auth/signin', request.url);
    signInUrl.searchParams.set('callbackUrl', pathname);
    return NextResponse.redirect(signInUrl);
  }

  return NextResponse.next();
}

export const config = {
  matcher: ['/mypage/:path*', '/subscription/:path*'],
};
```

## 8. 카카오 개발자 콘솔 설정

### 8.1 앱 생성
1. https://developers.kakao.com 접속
2. 내 애플리케이션 → 애플리케이션 추가하기

### 8.2 플랫폼 등록
1. 앱 설정 → 플랫폼
2. Web 플랫폼 등록
3. 사이트 도메인: `http://localhost:3000` (개발), `https://yourdomain.com` (배포)

### 8.3 카카오 로그인 활성화
1. 제품 설정 → 카카오 로그인
2. 활성화 설정: ON
3. Redirect URI 등록: `http://localhost:3000/api/auth/callback/kakao`

### 8.4 동의항목 설정
1. 제품 설정 → 카카오 로그인 → 동의항목
2. 필수 설정:
   - 닉네임: 필수 동의
   - 카카오계정(이메일): 필수 동의 (비즈 앱 전환 필요할 수 있음)

### 8.5 API 키 확인
1. 앱 설정 → 앱 키
2. REST API 키 → `KAKAO_CLIENT_ID`
3. 제품 설정 → 카카오 로그인 → 보안 → Client Secret 생성 → `KAKAO_CLIENT_SECRET`

### 8.6 팀원 추가 (개발 중 상태일 때)
1. 앱 설정 → 팀 관리
2. 팀원 초대 (테스트할 카카오 계정 이메일)

## 9. 구글 클라우드 콘솔 설정

### 9.1 프로젝트 생성
1. https://console.cloud.google.com 접속
2. 새 프로젝트 생성

### 9.2 OAuth 동의 화면
1. API 및 서비스 → OAuth 동의 화면
2. 외부 선택 → 앱 정보 입력
3. 범위: email, profile 추가

### 9.3 사용자 인증 정보
1. API 및 서비스 → 사용자 인증 정보
2. 사용자 인증 정보 만들기 → OAuth 클라이언트 ID
3. 웹 애플리케이션 선택
4. 승인된 리디렉션 URI: `http://localhost:3000/api/auth/callback/google`
5. 클라이언트 ID → `GOOGLE_CLIENT_ID`
6. 클라이언트 보안 비밀번호 → `GOOGLE_CLIENT_SECRET`

## 10. 자주 발생하는 에러

### 에러 1: Unknown argument `refresh_token_expires_in`
**원인**: 카카오가 반환하는 `refresh_token_expires_in` 필드가 Account 모델에 없음
**해결**: Account 모델에 `refresh_token_expires_in Int?` 추가 후 `prisma db push`

### 에러 2: adapter_error_linkAccount
**원인**: 이미 다른 방법으로 가입된 이메일
**해결**: Provider에 `allowDangerousEmailAccountLinking: true` 추가

### 에러 3: 등록하지 않은 리다이렉트 URI
**원인**: 카카오 개발자 콘솔에 Redirect URI 미등록
**해결**: 카카오 로그인 → Redirect URI에 `http://localhost:3000/api/auth/callback/kakao` 등록

### 에러 4: KOE006 앱 관리자 설정 오류
**원인**: 개발 중 상태에서 팀원이 아닌 계정으로 로그인 시도
**해결**: 앱 설정 → 팀 관리에서 테스트 계정 추가

### 에러 5: @auth/prisma-adapter 호환성 문제
**원인**: NextAuth v4에서 v5용 어댑터 사용
**해결**: `@auth/prisma-adapter` 대신 `@next-auth/prisma-adapter` 사용

## 11. TypeScript 타입 확장

파일: `src/types/next-auth.d.ts`

```typescript
import { DefaultSession } from "next-auth";

declare module "next-auth" {
  interface Session {
    user: {
      id: string;
      role: string;
    } & DefaultSession["user"];
  }
}
```

## 12. 배포 시 주의사항

1. `NEXTAUTH_URL`을 실제 도메인으로 변경
2. 카카오/구글 콘솔에서 배포 도메인 등록
3. Redirect URI도 배포 도메인으로 추가
4. `NEXTAUTH_SECRET`은 강력한 랜덤 문자열 사용 (`openssl rand -base64 32`)

---

## 요약 체크리스트

- [ ] `@next-auth/prisma-adapter` 설치 (v4용)
- [ ] Account 모델에 `refresh_token_expires_in Int?` 추가
- [ ] `prisma db push` 및 `prisma generate` 실행
- [ ] 환경변수 설정 (NEXTAUTH_SECRET, NEXTAUTH_URL, 각 Provider 키)
- [ ] SessionProvider로 앱 감싸기
- [ ] 카카오 개발자 콘솔: Redirect URI, 동의항목, 팀원 설정
- [ ] 구글 클라우드 콘솔: OAuth 클라이언트 ID 생성
- [ ] Provider에 `allowDangerousEmailAccountLinking: true` 추가
